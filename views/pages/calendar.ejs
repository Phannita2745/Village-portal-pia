<%
  // ใช้เดือน/ปีปัจจุบัน
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); // 0 = ม.ค.
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const monthsTH = ["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"];
%>

<div class="bg-white shadow p-6 rounded-lg">
  <div class="flex justify-between items-center mb-6">
    <h2 class="font-bold text-xl">ปฏิทิน</h2>
    <button id="btnCreate" class="bg-green-500 text-white px-4 py-1.5 text-sm rounded hover:bg-green-600">
      + สร้าง
    </button>
  </div>

  <div class="text-center mb-6">
    <p class="font-semibold text-lg"><%= monthsTH[month] %> <%= year %></p>
  </div>

  <div class="grid grid-cols-7 gap-2 text-sm text-gray-700 leading-9">
    <div class="font-semibold text-center">อา</div>
    <div class="font-semibold text-center">จ</div>
    <div class="font-semibold text-center">อ</div>
    <div class="font-semibold text-center">พ</div>
    <div class="font-semibold text-center">พฤ</div>
    <div class="font-semibold text-center">ศ</div>
    <div class="font-semibold text-center">ส</div>

    <% for (let i = 0; i < firstDay; i++) { %>
      <div></div>
    <% } %>

    <% for (let d = 1; d <= daysInMonth; d++) {
         const isToday = (d === now.getDate());
         const gcalDayUrl = `https://calendar.google.com/calendar/u/0/r/day/${year}/${month+1}/${d}`;
    %>
      <div class="relative">
        <!-- คลิกเลขวัน = เปิด Day view ของวันนั้น -->
        <div class="date-cell h-10 flex items-center justify-center rounded cursor-pointer
                    hover:bg-blue-100 <%= isToday ? 'bg-blue-200 text-blue-800 font-bold' : '' %>"
             data-day="<%= d %>">
          <a href="<%= gcalDayUrl %>" target="_blank" rel="noopener" class="block w-full h-full text-center"><%= d %></a>
        </div>
      </div>
    <% } %>
  </div>
</div>

<script>
(function () {
  const now = new Date();
  const year  = now.getFullYear();
  const month = now.getMonth()+1; // 1-based
  let selected = now.getDate();

  function pad(n){ return String(n).padStart(2,'0'); }
  function allDayRange(y,m,d){
    const start = `${y}${pad(m)}${pad(d)}`;
    const endDate = new Date(y, m-1, d+1);
    const end = `${endDate.getFullYear()}${pad(endDate.getMonth()+1)}${pad(endDate.getDate())}`;
    return `${start}/${end}`; // รูปแบบ all-day ของ GCal TEMPLATE
  }

  // เลือกวันไว้ใช้กับปุ่ม + สร้าง
  document.querySelectorAll('.date-cell').forEach(el=>{
    el.addEventListener('click', ()=>{
      selected = parseInt(el.dataset.day, 10);
      document.querySelectorAll('.date-cell').forEach(x=>x.classList.remove('bg-blue-200','text-blue-800','font-bold'));
      el.classList.add('bg-blue-200','text-blue-800','font-bold');
    });
  });

  // ปุ่ม + สร้าง -> เปิดหน้า create event ที่วันเลือกไว้ (All-day)
  document.getElementById('btnCreate').addEventListener('click', ()=>{
    const dates = allDayRange(year, month, selected);
    const title = encodeURIComponent('กิจกรรมชุมชน');
    const details = encodeURIComponent('สร้างจากเว็บไซต์หมู่บ้าน');
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}`;
    window.open(url, '_blank', 'noopener');
  });
})();
</script>
